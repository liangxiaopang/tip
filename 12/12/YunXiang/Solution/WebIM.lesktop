{"Data":{"Forms":[{"Constructor":"FormPH","Config":{"_Css":"window","HasMinButton":true,"HasMaxButton":true,"Resizable":true,"MemberCode":"","CustomConfigCode":"","Controls":[],"Count":0,"Left":0,"Top":0,"Width":400,"Height":300,"Name":"MainForm","Text":"主窗口","AnchorStyle":0}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"","InitCode":"","ClassName":"MsgPanel","Count":0,"Left":0,"Top":0,"Width":490,"Height":268,"Name":"m_MsgPanel","Text":"","AnchorStyle":15}},{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_MsgEditor_Config.BorderWidth = 1;\u000am_MsgEditor_Config.Css = \u0022richEditor\u0022;","InitCode":"","ClassName":"MsgEditor","Count":0,"Left":0,"Top":273,"Width":490,"Height":187,"Name":"m_MsgEditor","Text":"","AnchorStyle":13}},{"Constructor":"ButtonPH","Config":{"_Css":"button_default","OnClickCode":"var data = {\u000a    Sender: m_User\u002c\u000a    Receiver: m_Peer\u002c\u000a    Content: m_MsgEditor.GetValue()\u000a};\u000a\u000am_MsgPanel.AddMessage(data);\u000am_MsgEditor.SetValue(\u0022\u0022);\u000a\u000afunction Send_Error(ex)\u000a{\u000a    alert(ex);\u000a}\u000a\u000afunction Send_Callback(xml\u002c text)\u000a{\u000a    var message = System.ParseJson(text);\u000a}\u000a\u000aSystem.Post(Send_Callback\u002c Send_Error\u002c \u0022send.aspx\u0022\u002c System.RenderJson(data));","InitCode":"","Count":0,"Left":408,"Top":466,"Width":81,"Height":26,"Name":"m_BtnSend","Text":"发送","AnchorStyle":12}}],"MemberCode":"Controls.CreateHorizSplit(m_MsgPanel\u002c m_MsgEditor\u002c false);\u000a\u000avar m_User = config.User;\u000avar m_Peer = config.Peer;\u000a\u000avar m_From = new Date(0);\u000avar m_ErrorCount = 0;\u000a\u000afunction Receive()\u000a{\u000a    var data = {\u000a        Receiver: m_User\u002c\u000a        Sender: m_Peer\u002c\u000a        From: m_From\u000a    };\u000a\u000a    function Receive_Error(ex)\u000a    {\u000a        alert(ex);\u000a        m_ErrorCount++;\u000a        if (m_ErrorCount \u003c 5)\u000a        {\u000a            setTimeout(Receive\u002c 1000);\u000a        }\u000a    }\u000a\u000a    function Receive_Callback(xml\u002c text)\u000a    {\u000a        m_ErrorCount = 0;\u000a        var ret = System.ParseJson(text);\u000a        for (var i in ret.Messages)\u000a        {\u000a            m_MsgPanel.AddMessage(ret.Messages[i]);\u000a        }\u000a        if (ret.Messages.length \u003e 0)\u000a        {\u000a            m_From = ret.Messages[ret.Messages.length - 1].CreatedTime;\u000a        }\u000a        setTimeout(Receive\u002c 50);\u000a    }\u000a\u000a    System.Post(Receive_Callback\u002c Receive_Error\u002c \u0022recevie.aspx\u0022\u002c System.RenderJson(data));\u000a}\u000a\u000aReceive();","CustomConfig":"config.Css = \u0022MainWnd\u0022;","BaseName":"Control","GlobalCode":"","Count":8,"Left":33,"Top":26,"Width":490,"Height":493,"Name":"ChatPanel","Text":"","AnchorStyle":0}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[],"MemberCode":"This.AddMessage = function(msg)\u000a{\u000a    var msgDiv = This.GetDocument().createElement(\u0022DIV\u0022);\u000a    msgDiv.className = \u0022message\u0022;\u000a    msgDiv.innerHTML = String.format(MessageFormat\u002c msg.Sender\u002c DateToString(msg.CreatedTime == undefined ? new Date() : msg.CreatedTime)\u002c msg.Content);\u000a    This.GetDocument().body.appendChild(msgDiv);\u000a    //msgDiv.scrollIntoView();\u000a    This.GetDocument().body.scrollTop = This.GetDocument().body.scrollHeight;\u000a    msgDiv = null;\u000a}\u000a\u000aThis.Link(\u0022StyleSheet\u0022\u002c (BaseDirectory == \u0022\u0022 ? \u0022\u0022: BaseDirectory + \u0022/\u0022) + \u0022Themes/Default/EditorCss.css\u0022\u002c \u0022text/css\u0022);","CustomConfig":"config.BorderWidth = 1;\u000aconfig.Css = \u0022MsgPanel\u0022;","BaseName":"Controls.Frame","GlobalCode":"","Count":0,"Left":108,"Top":51,"Width":200,"Height":200,"Name":"MsgPanel","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"FormPH","Config":{"_Css":"window","HasMinButton":false,"HasMaxButton":false,"Resizable":false,"MemberCode":"var m_Result = false;\u000a\u000aThis.GetResult = function()\u000a{\u000a    return m_Result;\u000a}\u000a\u000aThis.GetUser = function()\u000a{\u000a    return m_User.GetText();\u000a}\u000a\u000aThis.GetPeer = function()\u000a{\u000a    return m_Peer.GetText();\u000a}\u000a\u000aThis.SetAcceptButton(button5);","CustomConfigCode":"","Controls":[{"Constructor":"LabelPH","Config":{"_Css":"label","InitCode":"","Count":0,"Left":9,"Top":19,"Width":78,"Height":14,"Name":"label1","Text":"你的用户名：","AnchorStyle":3}},{"Constructor":"TextBoxPH","Config":{"_Css":"textbox","InitCode":"","BorderWidth":1,"Count":0,"Left":96,"Top":14,"Width":216,"Height":22,"Name":"m_User","Text":"","AnchorStyle":3}},{"Constructor":"LabelPH","Config":{"_Css":"label","InitCode":"","Count":0,"Left":10,"Top":52,"Width":82,"Height":14,"Name":"label3","Text":"对方用户名：","AnchorStyle":3}},{"Constructor":"TextBoxPH","Config":{"_Css":"textbox","InitCode":"","BorderWidth":1,"Count":0,"Left":96,"Top":47,"Width":215,"Height":22,"Name":"m_Peer","Text":"","AnchorStyle":3}},{"Constructor":"ButtonPH","Config":{"_Css":"button_default","OnClickCode":"if (m_User.GetText() == \u0022\u0022)\u000a{\u000a    alert(\u0022请输入您的用户名！\u0022);\u000a    return;\u000a}\u000aif (m_Peer.GetText() == \u0022\u0022)\u000a{\u000a    alert(\u0022请输入对方用户名！\u0022);\u000a    return;\u000a}\u000am_Result = true;\u000aThis.Close();","InitCode":"","Count":0,"Left":214,"Top":79,"Width":96,"Height":26,"Name":"button5","Text":"开始会话","AnchorStyle":3}}],"Count":5,"Left":17,"Top":34,"Width":332,"Height":144,"Name":"GetUserForm","Text":"用户名","AnchorStyle":3}},{"Constructor":"CustomControlDesignPH","Config":{"Controls":[],"MemberCode":"","CustomConfig":"config.StyleSheet = (BaseDirectory == \u0022\u0022 ? \u0022\u0022: BaseDirectory + \u0022/\u0022) + \u0022Themes/Default/EditorCss.css\u0022;","BaseName":"RichEditor","GlobalCode":"","Count":0,"Left":0,"Top":0,"Width":200,"Height":200,"Name":"MsgEditor","Text":"CustomControl1","AnchorStyle":3}},{"Constructor":"FormPH","Config":{"_Css":"window","HasMinButton":true,"HasMaxButton":true,"Resizable":true,"MemberCode":"","CustomConfigCode":"config.Title.InnerHTML = String.format(\u0022与 \u005c\u0022{0}\u005c\u0022 交谈中\u0022\u002c arguments[1]);","Controls":[{"Constructor":"CustomControlObjectPH","Config":{"_Css":"control","ConfigCode":"m_ChatPanel_Config.User = arguments[0];\u000am_ChatPanel_Config.Peer = arguments[1];","InitCode":"","ClassName":"ChatPanel","Count":0,"Left":7,"Top":7,"Width":482,"Height":452,"Name":"m_ChatPanel","Text":"","AnchorStyle":15}}],"Count":1,"Left":11,"Top":8,"Width":508,"Height":495,"Name":"ChatForm","Text":"Form1","AnchorStyle":3}}],"InitCode":"completeCallback();","DisposeCode":"completeCallback();","ModuleGlobalCode":"\u000avar MessageFormat=\u000a\u0022\u003cdiv class=\u0027message\u0027\u003e\u0022 + \u000a    \u0022\u003cdiv class=\u0027messageTitle\u0027\u003e\u0022 + \u000a        \u0022\u003cspan class=\u0027sender\u0027\u003e{0}\u003c/span\u003e\u0022 + \u000a        \u0022\u003cspan class=\u0027time\u0027\u003e{1}\u003c/span\u003e\u0022 + \u000a    \u0022\u003c/div\u003e\u0022 + \u000a    \u0022\u003cdiv class=\u0027messageContent\u0027\u003e{2}\u003c/div\u003e\u0022 + \u000a\u0022\u003c/div\u003e\u003cbr/\u003e\u0022;\u000a\u000a//格式化数字\u000afunction FormatNumber(num\u002c length)\u000a{\u000a    var s = num.toString();\u000a    var zero = \u0022\u0022;\u000a    for (var i = 0; i \u003c length - s.length; i++) zero += \u00220\u0022;\u000a    return zero + s;\u000a}\u000a\u000a//时间转字符串\u000afunction DateToString(date)\u000a{\u000a    return String.format(\u0022{0}-{1}-{2} {3}:{4}:{5}\u0022\u002c FormatNumber(date.getFullYear()\u002c 4)\u002c FormatNumber(date.getMonth() + 1\u002c 2)\u002c FormatNumber(date.getDate()\u002c 2)\u002c FormatNumber(date.getHours()\u002c 2)\u002c FormatNumber(date.getMinutes()\u002c 2)\u002c FormatNumber(date.getSeconds()\u002c 2));\u000a}","AppStartCode":"var user = arguments[1];\u000avar peer = arguments[2];\u000a\u000afunction StartChat(user\u002c peer)\u000a{\u000a    var form = new ChatForm(user\u002c peer);\u000a    form.MoveEx(\u0022center\u0022\u002c 0\u002c 0);\u000a    form.Show();\u000a}\u000a\u000afunction GetUser_OnClose()\u000a{\u000a    if (guform.GetResult() == false) return;\u000a\u000a    user = guform.GetUser();\u000a    peer = guform.GetPeer();\u000a\u000a    StartChat(user\u002c peer);\u000a\u000a}\u000a\u000aif (user == undefined || peer == undefined)\u000a{\u000a    var guform = new GetUserForm();\u000a    guform.OnClosed.Attach(GetUser_OnClose);\u000a    guform.MoveEx(\u0022center\u0022\u002c 0\u002c -100);\u000a    guform.Show();\u000a}\u000aelse\u000a{\u000a    StartChat(user\u002c peer);\u000a}","AppGlobal":"","AppTerminateCode":"completeCallback();"},"Css":{"CssCode":".MsgPanel\u000a{\u000a    border: solid 1px #D0D0D0;\u000a    background-color:#FFFFFF;\u000a}\u000a\u000a.MainWnd\u000a{\u000a    background-color:#EFF0F2;\u000a}"},"Version":"1.0"}